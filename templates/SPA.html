<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Clone</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- ç™»å½•/æ³¨å†Œç•Œé¢ -->
    <div id="login-register-form">
        <h2>ChatGPT Clone</h2>
        <input type="text" id="username" placeholder="Username" required />
        <input type="password" id="password" placeholder="Password" required />
        <button onclick="loginUser()">Login</button>
        <button onclick="registerUser()">Register</button>
        <p id="error-message" style="color: red;"></p>
    </div>

    <!-- é€‰æ‹© Start Chat æˆ– History ç•Œé¢ -->
    <div id="selection-container" style="display:none;">
        <h2>Welcome!</h2>
        <button onclick="showChatNaming()">Start Chat</button>
        <button onclick="fetchChatHistoryList()">History</button>
        <button onclick="logoutUser()">Logout</button>
    </div>

    <!-- å‘½åæ–°å¯¹è¯ -->
    <div id="chat-naming-container" style="display:none;">
        <h2>Name Your Chat</h2>
        <input type="text" id="chat-name" placeholder="Enter chat name..." required />
        <button onclick="startChat()">Start</button>
        <button onclick="goBack()">Return</button>
    </div>

    <!-- èŠå¤©ç•Œé¢ -->
    <div id="chat-container" style="display:none;">
        <h2 id="chat-title">Chat with GPT</h2>
        <div id="chat-box" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>
        <input type="text" id="message" placeholder="Enter message..." />
        <button onclick="sendMessage()">Send</button>
        <button onclick="returnToSelection()">Return</button>
    </div>

    <!-- å†å²è®°å½•ç•Œé¢ -->
    <div id="history-container" style="display:none;">
        <h2>Chat History</h2>
        <ul id="history-list"></ul>
        <button onclick="returnToSelection()">Return</button>
    </div>

    <script>
        let currentChatName = '';

        // å¤„ç†æ³¨å†Œ
        async function registerUser() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    body: JSON.stringify({ username, password }),
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                document.getElementById('error-message').innerText = data.message;
            } catch (error) {
                console.error("Registration error:", error);
            }
        }

        // å¤„ç†ç™»å½•
        async function loginUser() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password }),
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    document.getElementById('login-register-form').style.display = 'none';
                    document.getElementById('selection-container').style.display = 'block';
                } else {
                    document.getElementById('error-message').innerText = data.message;
                }
            } catch (error) {
                console.error("Login error:", error);
            }
        }

        // æ˜¾ç¤ºå‘½åèŠå¤©ç•Œé¢
        function showChatNaming() {
            document.getElementById('selection-container').style.display = 'none';
            document.getElementById('chat-naming-container').style.display = 'block';
        }

        // å¤„ç†æ–°å¯¹è¯
        async function startChat() {
            const chatName = document.getElementById('chat-name').value.trim();
            if (!chatName) return alert("Chat name cannot be empty!");

            currentChatName = chatName;
            document.getElementById('chat-box').innerHTML = "";

            const response = await fetch('/api/start_chat', {
                method: 'POST',
                body: JSON.stringify({ chat_name: chatName }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });

            const data = await response.json();
            if (response.ok) {
                document.getElementById('chat-title').innerText = `Chat: ${chatName}`;
                document.getElementById('chat-naming-container').style.display = 'none';
                document.getElementById('chat-container').style.display = 'block';
                fetchChatHistory(chatName);
            } else {
                alert(data.message);
            }
        }

        // è·å–å†å²å¯¹è¯åˆ—è¡¨
        async function fetchChatHistoryList() {
            try {
                const response = await fetch('/api/chat_list', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('selection-container').style.display = 'none';
                    document.getElementById('history-container').style.display = 'block';

                    const historyList = document.getElementById('history-list');
                    historyList.innerHTML = '';

                    data.chats.forEach(chat => {
                        const li = document.createElement('li');

                        // âœ… åˆ›å»ºèŠå¤©åç§°é“¾æ¥
                        const chatLink = document.createElement('a');
                        chatLink.href = "#";
                        chatLink.innerText = chat;
                        chatLink.onclick = () => resumeChat(chat);

                        // âœ… åˆ›å»ºåˆ é™¤æŒ‰é’®
                        const deleteButton = document.createElement('button');
                        deleteButton.innerText = "ğŸ—‘ï¸ Delete";
                        deleteButton.classList.add("delete-btn");
                        deleteButton.onclick = () => deleteChat(chat);

                        li.appendChild(chatLink);
                        li.appendChild(deleteButton);
                        historyList.appendChild(li);
                    });
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error("Error fetching chat history:", error);
            }
        }

        // æ‹‰å–å†å²å¯¹è¯å†…å®¹
        async function fetchChatHistory(chatName) {
            try {
                const response = await fetch(`/api/chat_history?chat_name=${encodeURIComponent(chatName)}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });

                const data = await response.json();
                console.log("[DEBUG] Chat history:", data); // âœ… æ·»åŠ è°ƒè¯•

                if (response.ok && data.messages) {
                    const chatBox = document.getElementById('chat-box');
                    chatBox.innerHTML = "";

                    data.messages.forEach(msg => {
                        const sender = msg.role || "Unknown";  // âœ… é¿å… undefined
                        const message = msg.content || "[Empty Message]";  // âœ… é¿å… undefined
                        updateChatBox(sender, message);
                    });
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error("Error fetching chat history:", error);
            }
        }

        async function deleteChat(chatName) {
            if (!confirm(`Are you sure you want to delete "${chatName}"?`)) return;

            try {
                const response = await fetch('/api/delete_chat', {
                    method: 'POST',
                    body: JSON.stringify({ chat_name: chatName }),
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    alert("Chat deleted successfully");
                    fetchChatHistoryList(); // âœ… é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error("Error deleting chat:", error);
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆæµå¼å“åº”ï¼‰
        async function sendMessage() {
            const message = document.getElementById('message').value.trim();
            if (!message) return;

            // å…ˆæ˜¾ç¤ºç”¨æˆ·è¿™è¡Œ
            updateChatBox('User', message);
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('message').value = '';

            try {
                const response = await fetch('/api/send_message', {
                    method: 'POST',
                    body: JSON.stringify({ message, chat_name: currentChatName }),
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let done = false;
                let assistantMessage = '';

                // å…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„ GPT è¡Œï¼Œåç»­ä»…æ›´æ–°è¿™è¡Œæ–‡æœ¬
                updateChatBox('GPT', '');

                while (!done) {
                    const { value, done: readerDone } = await reader.read();
                    done = readerDone;
                    if (value) {
                        // æœ¬æ¬¡è¯»å–åˆ°çš„æ–° chunk å†…å®¹
                        const chunk = decoder.decode(value, { stream: true });
                        console.log("[DEBUG] chunk in front-end:", chunk);

                        // ç´¯åŠ åˆ° assistantMessage
                        assistantMessage += chunk;

                        // åªæ›´æ–°æœ€åä¸€è¡Œ GPT å†…å®¹
                        updateLastChatBubble('GPT', assistantMessage);
                    }
                }

            } catch (error) {
                console.error("Send message error:", error);
            }
        }

        function mapRoleToDisplayName(role) {
            if (role === 'assistant') return 'GPT';
            if (role === 'user') return 'User';
            return 'unidentified';
        }
        // æ›´æ–°èŠå¤©æ¡†ï¼ˆæ–°å¢ä¸€æ¡æ¶ˆæ¯ï¼‰
        function updateChatBox(sender, message) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');

            // èµ‹äºˆæ¶ˆæ¯é€‚å½“çš„ç±»
            messageDiv.classList.add('chat-message', sender.toLowerCase() === 'user' ? 'user' : 'assistant');

            // æ’å…¥æ¶ˆæ¯å†…å®¹
            messageDiv.innerHTML = `<p><strong>${sender}:</strong> ${message}</p>`;

            // æ·»åŠ åˆ°èŠå¤©æ¡†
            chatBox.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatBox.scrollTop = chatBox.scrollHeight;
        }



        // ä»…æ›´æ–°â€œæœ€åä¸€è¡Œâ€æŒ‡å®š sender çš„æ–‡æœ¬
        function updateLastChatBubble(sender, newContent) {
            const chatBox = document.getElementById('chat-box');
            const paragraphs = chatBox.getElementsByTagName('p');

            // ä»åå¾€å‰æ‰¾ï¼ŒåŒ¹é… â€œsender:â€
            for (let i = paragraphs.length - 1; i >= 0; i--) {
                const p = paragraphs[i];
                if (p.textContent.startsWith(`${sender}:`)) {
                    // æ‰¾åˆ°æœ€åä¸€ä¸ªåŒæ ·senderçš„è¡Œï¼Œæ›´æ–°å…¶å†…å®¹
                    p.innerHTML = `<strong>${sender}:</strong> ${newContent}`;
                    return;
                }
            }
        }

        // ç»§ç»­å†å²å¯¹è¯
        function resumeChat(chatName) {
            currentChatName = chatName;
            document.getElementById('history-container').style.display = 'none';
            document.getElementById('chat-title').innerText = `Chat: ${chatName}`;
            document.getElementById('chat-container').style.display = 'block';

            document.getElementById('chat-box').innerHTML = "";
            fetchChatHistory(chatName);
        }

        // è¿”å›é€‰æ‹©ç•Œé¢
        function returnToSelection() {
            document.getElementById('chat-container').style.display = 'none';
            document.getElementById('history-container').style.display = 'none';
            document.getElementById('selection-container').style.display = 'block';
        }

        // è¿”å›å‘½åç•Œé¢
        function goBack() {
            document.getElementById('chat-naming-container').style.display = 'none';
            document.getElementById('selection-container').style.display = 'block';
        }

        // å¤„ç†ç™»å‡º
        function logoutUser() {
            localStorage.removeItem('token');
            document.getElementById('selection-container').style.display = 'none';
            document.getElementById('login-register-form').style.display = 'block';
        }
    </script>
</body>
</html>